<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charSet="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="icon" href="/assets/favicon-32x32.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@100;400;700&display=swap');
    </style>
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" sizes="48x48" href="/assets/icons/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/assets/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="256x256" href="/assets/icons/icon-256x256.png">
    <link rel="apple-touch-icon" sizes="384x384" href="/assets/icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/assets/icons/icon-512x512.png">
    <link href="/styles/styles.css" rel="stylesheet" />
    <link href="/styles/prism.css" rel="stylesheet" />
    <script type='module' src='/js/starscape.js'></script>
    <script src='/js/prism.js'></script>
    <title>Creating a canvas platformer tutorial part two - Somethinghitme</title>
</head>  <body>
    <div class="layout">
        <header class="header">
    <h1><a aria-current="page" href="/">Somethinghitme</a></h1>
    <h2>Code, demos and ideas.</h2>
</header>        <main class="main">
            <section class="primary">
                <article class="blog-post">
                    <header>
                        <h3>Creating a canvas platformer tutorial part two</h3>
                        <p>
                            Wednesday, Apr 17, 2013                        </p>
                    </header>
                    <section>
                        <p>Wow, so its been a while since I've posted anything. I've been kind of busy, and was forcing myself not to post anything unless it was going to be part two of the tutorial. With that said lets begin! For all the code and fully working demo scroll to the bottom.</p>
<p>Last we left off we had a pretty complete demo where we could run and jump around the screen. Now we are going to add some objects that the player can actually collide into!</p>
<p>Lets add an array called boxes to hold the objects well be doing collision checks against, and lets block the player from falling out of the screen by using our objects.</p>
<p>[sourcecode language="js"]</p>
<p>var boxes = []</p>
<p>// dimensions boxes.push({ x: 0, y: 0, width: 10, height: height }); boxes.push({ x: 0, y: height - 2, width: width, height: 50 }); boxes.push({ x: width - 10, y: 0, width: 50, height: height });</p>
<p>[/sourcecode]</p>
<p>The above code sets up three boxes to enclose our game world. If you remember from the last tutorial we are checking coordinates directly to keep the player within the bounds, however since we are adding collisions we can just let our collision function handle that for us.</p>
<p>Lets got ahead and add some logic to draw the boxes so you can see them. Add the following code to your update function between clearRect and ctx.fillStyle = "red".</p>
<p>[sourcecode language="js"]</p>
<p>ctx.fillStyle = "black"; ctx.beginPath();</p>
<p>for (var i = 0; i &lt; boxes.length; i++) { ctx.rect(boxes[i].x, boxes[i].y, boxes[i].width, boxes[i].height); }</p>
<p>ctx.fill(); [/sourcecode]</p>
<p>You should now see some thick black boxes on the left, right, and bottom of your canvas. Now lets actually make the player collide against them!</p>
<p>So Im going to give a pretty brief primer of the collision method we are using. We are going to be checking two objects against each other, the player, and a box. We will do this by checking if they intersect. If they intersect then they must be colliding. Since we are working on a platformer we need one more piece of information, from which direction is the player colliding? Go ahead and add the below function, it does just that!</p>
<p>[sourcecode language="js"] function colCheck(shapeA, shapeB) { // get the vectors to check against var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)), vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)), // add the half widths and half heights of the objects hWidths = (shapeA.width / 2) + (shapeB.width / 2), hHeights = (shapeA.height / 2) + (shapeB.height / 2), colDir = null;</p>
<p>// if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) { // figures out on which side we are colliding (top, bottom, left, or right) var oX = hWidths - Math.abs(vX), oY = hHeights - Math.abs(vY); if (oX >= oY) { if (vY &gt; 0) { colDir = "t"; shapeA.y += oY; } else { colDir = "b"; shapeA.y -= oY; } } else { if (vX &gt; 0) { colDir = "l"; shapeA.x += oX; } else { colDir = "r"; shapeA.x -= oX; } } } return colDir; } [/sourcecode]</p>
<p>The code is easy to figure out if you stare at it for a bit, but Ill go ahead and give a quick explanation of whats going on. First we need to calculate the current vector from the center of our objects, which is done in the very beginning.</p>
<p>[caption id="attachment_609" align="aligncenter" width="300"]<a href="http://www.somethinghitme.com/wp-content/uploads/2013/04/fig1.png"><img src="/2013/04/16/creating-a-canvas-platformer-tutorial-part-tw/images/fig1.png" alt="figure 1" title="Figure 1" /></a> The player and box object at their current positions ready to be checked to see if they are colliding./[/caption/]</p>
<p>The above image shows the player and one of our boxes. We can tell they aren't currently colliding but lets step through to see how the function figures it out.</p>
<p>[caption id="attachment_610" align="aligncenter" width="300"]<a href="http://www.somethinghitme.com/wp-content/uploads/2013/04/fig2.png"><img src="/2013/04/16/creating-a-canvas-platformer-tutorial-part-tw/images/fig2.png" alt="fig2" title="Figure 2" /></a> Showing the vector calculation and half width, half height calculations./[/caption/]</p>
<p>Above shows the values we end up with for the vector, half widths, and half heights. The function checks the absolute values of the vector to see if they are less than the half width, and half height. If they are there is a collision. As you see from above our vector needed an x component of 25 or less, along with the y. Since they our values were both 35 (remember we check the absolute value meaning the -35 turns to 35) that means we are too far away and are currently not intersecting.</p>
<p>Now lets take a look at an example where the player and the box are intersecting.</p>
<p>[caption id="attachment_612" align="aligncenter" width="300"]<a href="http://www.somethinghitme.com/wp-content/uploads/2013/04/fig3.png"><img src="/2013/04/16/creating-a-canvas-platformer-tutorial-part-tw/images/fig3.png" alt="fig3" title="Player and box intersecting" /></a> The player and the box are now intersecting since the vector components are less than the half width and half height./[/caption/]</p>
<p>The above uses the same dimensions for the box and player, all we did was move the player closer to the box. The values for the x and y component of the vector come out to less than 25, meaning a collision has occurred. Now using this information we can actually get which side the collision occurred on. To do this we need to first figure out the offset vector, meaning how far are we into the other object. The below illustration shows how we do that.</p>
<p>[caption id="attachment_615" align="aligncenter" width="300"]<a href="http://www.somethinghitme.com/wp-content/uploads/2013/04/fig4.png"><img src="/2013/04/16/creating-a-canvas-platformer-tutorial-part-tw/images/fig4.png" alt="Calculating the offset vector after a collision has occured." /></a> Calculating the offset vector after a collision has&nbsp;occurred./[/caption/]</p>
<p>So now we have the offsets, what do we need to do with them? First we check if the x components offset is greater than the y. If so that would tell us we either collided with the top or bottom of the object, because the assumption is the greater penetration is not actually *in* the object since we would have caught it much sooner. In our case the y offset is much greater meaning we collided with the left or right of the object and since our original vectors X is a positive number, it means it was on the left. If we were on the right side our x value would have came out positive due to the x coordinate of the player being greater than the x coordinate of the box.</p>
<p>Now we need to move the objects outside of each other, if we don't then they will just go further inside one another. This is very easy since we already have the offsets, and since we determined we collided on the left side, we move our box to the left by 2.</p>
<p>Alright so you have this collision function.. what the heck do you do with it? All you need to do is add the following inside the drawing loop for your boxes.</p>
<p>[sourcecode language="js"] var dir = colCheck(player, boxes[i]); [/sourcecode]</p>
<p>Now we need to add a couple more things before we can actually do anything with the collisions. Add the property grounded, and sliding to your player object and set it false initially. Since we are going to have different things to jump off of we need to know if we are on solid ground or not, or if we should keep falling raising. Your player object should now look like this.</p>
<p>[sourcecode language="js"] player = { x: width / 2, y: height - 5, width: 5, height: 5, speed: 3, velX: 0, velY: 0, jumping: false, grounded: false }, [/sourcecode]</p>
<p>Lets go ahead and add the check to our jumping condition, change your jump key condition to the following.</p>
<p>[sourcecode language="js"] if (keys[38] || keys[32]) { // up arrow or space if (!player.jumping &amp;&amp; player.grounded) { player.jumping = true; player.grounded = false; // We're not on the ground anymore!! player.velY = -player.speed * 2; } } [/sourcecode]</p>
<p>By looking at that you can see we can only jump if we are on the ground and are currently not jumping, and every time we jump set grounded to false. We also need to set grounded to false before we do the collision check every time so our player can fall off ledges, add the following right before the box loop.</p>
<p>[sourcecode language="js"] player.grounded = false; [/sourcecode]</p>
<p>Now lets go ahead and remove the following from your code, since we are going to be using our collision system instead of hard constraints when keeping the player in the canvas.</p>
<p>[sourcecode language="js"] if (player.x &gt;= width - player.width) { player.x = width - player.width; } else if (player.x <= 0) { player.x = 0; } if (player.y >= height - player.height) { player.y = height - player.height; player.jumping = false; } [/sourcecode]</p>
<p>We just removed what told us our player isn't jumping anymore! We need to add some of that logic back in somewhere else! Add the following into your update function inside the box loop where you call the colCheck function.</p>
<p>[sourcecode language="js"] if (dir === "l" || dir === "r") { player.velX = 0; player.jumping = false; } else if (dir === "b") { player.grounded = true; player.jumping = false; } else if (dir === "t") { player.velY *= -1; }</p>
<p>[/sourcecode]</p>
<p>As you can see from that, if the collision direction is on the left or right we stop the player from moving left or right, if its on the bottom we set grounded to true since our feet have touched some sort of ground, and if its top, we just reverse the current force of our jump since we hit our head on the ceiling. You could just as easily make velY 0 but it feels a bit floaty to me.</p>
<p>The last thing you need to do is put the following code right after the box loop.</p>
<p>[sourcecode language="javascript"] if(player.grounded){ player.velY = 0; }</p>
<p>player.x += player.velX; player.y += player.velY; [/sourcecode]</p>
<p>Delete the previous occurrence of player.x += player.velX, and player.y += player.velY. Go ahead and run it! If there are no errors the player should not fall through the world and should be able to run and jump around.. acting just like our previous demo!.. wait, so we did all that work just to make it like the last demo? Of course not, lets add some boxes right under the section where we declared our first set of boxes.</p>
<p>[sourcecode language="js"] boxes.push({ x: 120, y: 10, width: 80, height: 80 }); boxes.push({ x: 170, y: 50, width: 80, height: 80 }); boxes.push({ x: 220, y: 100, width: 80, height: 80 }); boxes.push({ x: 270, y: 150, width: 40, height: 40 }); [/sourcecode]</p>
<p>Now go ahead run around and jump!</p>
<p>The entire program should look like the following</p>
<p>[sourcecode langauge="js"] (function () { var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame; window.requestAnimationFrame = requestAnimationFrame; })();</p>
<p>var canvas = document.getElementById("canvas"), ctx = canvas.getContext("2d"), width = 500, height = 200, player = { x: width / 2, y: height - 15, width: 5, height: 5, speed: 3, velX: 0, velY: 0, jumping: false, grounded: false }, keys = [], friction = 0.8, gravity = 0.3;</p>
<p>var boxes = [];</p>
<p>// dimensions boxes.push({ x: 0, y: 0, width: 10, height: height }); boxes.push({ x: 0, y: height - 2, width: width, height: 50 }); boxes.push({ x: width - 10, y: 0, width: 50, height: height });</p>
<p>boxes.push({ x: 120, y: 10, width: 80, height: 80 }); boxes.push({ x: 170, y: 50, width: 80, height: 80 }); boxes.push({ x: 220, y: 100, width: 80, height: 80 }); boxes.push({ x: 270, y: 150, width: 40, height: 40 });</p>
<p>canvas.width = width; canvas.height = height;</p>
<p>function update() { // check keys if (keys[38] || keys[32]) { // up arrow or space if (!player.jumping &amp;&amp; player.grounded) { player.jumping = true; player.grounded = false; player.velY = -player.speed * 2; } } if (keys[39]) { // right arrow if (player.velX < player.speed) { player.velX++; } } if (keys[37]) { // left arrow if (player.velX > -player.speed) { player.velX--; } }</p>
<p>player.velX *= friction; player.velY += gravity;</p>
<p>ctx.clearRect(0, 0, width, height); ctx.fillStyle = "black"; ctx.beginPath();</p>
<p>player.grounded = false; for (var i = 0; i &lt; boxes.length; i++) { ctx.rect(boxes[i].x, boxes[i].y, boxes[i].width, boxes[i].height);</p>
<p>var dir = colCheck(player, boxes[i]);</p>
<p>if (dir === "l" || dir === "r") { player.velX = 0; player.jumping = false; } else if (dir === "b") { player.grounded = true; player.jumping = false; } else if (dir === "t") { player.velY *= -1; }</p>
<p>}</p>
<p>if(player.grounded){ player.velY = 0; }</p>
<p>player.x += player.velX; player.y += player.velY;</p>
<p>ctx.fill(); ctx.fillStyle = "red"; ctx.fillRect(player.x, player.y, player.width, player.height);</p>
<p>requestAnimationFrame(update); }</p>
<p>function colCheck(shapeA, shapeB) { // get the vectors to check against var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)), vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)), // add the half widths and half heights of the objects hWidths = (shapeA.width / 2) + (shapeB.width / 2), hHeights = (shapeA.height / 2) + (shapeB.height / 2), colDir = null;</p>
<p>// if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) { // figures out on which side we are colliding (top, bottom, left, or right) var oX = hWidths - Math.abs(vX), oY = hHeights - Math.abs(vY); if (oX >= oY) { if (vY &gt; 0) { colDir = "t"; shapeA.y += oY; } else { colDir = "b"; shapeA.y -= oY; } } else { if (vX &gt; 0) { colDir = "l"; shapeA.x += oX; } else { colDir = "r"; shapeA.x -= oX; } } } return colDir; }</p>
<p>document.body.addEventListener("keydown", function (e) { keys[e.keyCode] = true; });</p>
<p>document.body.addEventListener("keyup", function (e) { keys[e.keyCode] = false; });</p>
<p>window.addEventListener("load", function () { update(); }); [/sourcecode]</p>
<pre><code>
</code></pre>
<p>&nbsp;</p>
<p><a href="http://jsfiddle.net/loktar/da9cP/">Link to the code on jsfiddle</a></p>                    </section>
                    <hr/>
                    <footer>
                                            </footer>
                </article>
                <nav class="nav">
    <ul>
        <li><a class="link-button" rel="prev" href="/2013/06/20/atari-rom-reader-and-color-picker/">← Atari Rom Reader, and color picker</a></li>        <li><a class="link-button" rel="prev" href="/2013/01/09/creating-a-canvas-platformer-tutorial-part-one/">Creating a canvas platformer tutorial part one →</a></li>    </ul>
</nav>            </section>
            <section class="secondary">
                <aside class="aside-list">
            <h3>Find Me</h3>
            <ol>
                <li><a href="https://twitter.com/loktar00">@loktar00</a></li><li><a href="https://codepen.io/loktar00">Codepen</a></li><li><a href="https://github.com/loktar00">Github</a></li><li><a href="https://stackoverflow.com/users/322395/loktar">Stackoverflow</a></li><li><a href="https://www.dwitter.net/u/loktar">Dwitter</a></li>
            </ol>
        </aside><aside class="aside-list">
            <h3>Projects</h3>
            <ol>
                <li><a href="https://github.com/loktar00/react-lazy-load">react-lazy-load</a></li><li><a href="https://catbrownrealtor.com/">Cat Brown Realtor</a></li><li><a href="https://github.com/loktar00/jest">Jest Game Framework</a></li><li><a href="https://codegolf.stackexchange.com/questions/30322/make-it-look-like-im-working/30335#30335">gui hacker</a></li><li><a href="https://github.com/loktar00/JQuery-Snowfall">jQuery Snowfall</a></li><li><a href="http://www.retroships.com/">RetroShips</a></li><li><a href="https://zombiegames.net/">Zombiegames.net</a></li>
            </ol>
        </aside>            </section>
        </main>
        <footer class="footer">
    © 2023, Built by <a href="https://github.com/loktar00">Loktar</a>
</footer>    </div>
  </body>