<!DOCTYPE html>
<html lang="en">
    <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YJDK7X0K15"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YJDK7X0K15');
    </script>
    <meta charSet="utf-8" />
    <meta name="description" content="Jason Browns Code, demos and ideas."/>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="icon" href="/assets/favicon-32x32.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@100;400;700&display=swap');
    </style>
    <link rel="manifest" href="/assets/manifest.webmanifest">
    <link rel="apple-touch-icon" sizes="48x48" href="/assets/icons/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/assets/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="256x256" href="/assets/icons/icon-256x256.png">
    <link rel="apple-touch-icon" sizes="384x384" href="/assets/icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/assets/icons/icon-512x512.png">
    <link href="/styles/styles.css" rel="stylesheet" />
    <link href="/styles/prism.css" rel="stylesheet" />
    <script type='module' src='/js/starscape.js'></script>
    <script src='/js/prism.js'></script>
    <title>Deep copying in JavaScript - Somethinghitme</title>
</head>  <body>
    <div class="layout">
        <header class="header">
    <h1><a aria-current="page" href="/">Somethinghitme</a></h1>
    <h2>Code, demos and ideas.</h2>
</header>        <main class="main">
            <section class="primary">
                <article class="blog-post">
                    <header>
                        <h3>Deep copying in JavaScript</h3>
                        <p>
                            Wednesday, Apr 27, 2022                        </p>
                    </header>
                    <section>
                        <h2 id="deepcopyingcloninginjavascript">Deep copying / cloning in JavaScript</h2>
<p><strong>tldr; structuredClone</strong></p>
<h3 id="copyingbyvalueorreference">Copying by value or reference</h3>
<p>Before we talk about deep cloning let's take a step back and talk about passing by value or by reference. Quick explanation, copying by value assigns the data to a new memory address, whereas copying by reference just points to the memory address which has the original value.</p>
<p><strong>Example of a primitive type in JavaScript being copied by value:</strong></p>
<pre><code class="javascript language-javascript">let a = 'Hello!';
const b = a;

a = 'Bye!'

console.log(b) // Hello!
</code></pre>
<p>Primitive types copied by value:  string, number, boolean, undefined, null,</p>
<p><strong>Example of a type being copied by reference:</strong></p>
<pre><code class="javascript language-javascript">let a = [1, 2, 3, 4];
const b = a;

a[0] = 'first index in the array!';

console.log(b) // ['first index in the array!', 2, 3, 4]

let foo = { prop: 123 };
let bar = foo;

foo.prop = 456;

console.log(bar); // 456
</code></pre>
<p>The above will happen with object, array, and function</p>
<h2 id="deepcopyinginjsonlyskindeep">Deep copying in JS only skin deep</h2>
<p>JavaScript will only naturally deep copy 1 level deep, and only the primitive types mentioned above.</p>
<p><strong>Deep copy, by value when one level deep:</strong></p>
<pre><code class="javascript language-javascript">let a = [1, 2, 3, 4];
const b = [...a]; // a.map(el =&gt; el), a.forEach(el =&gt; b.push(el));

a[0] = 'first index in the array!';

console.log(b) // ['first index in the array!', 2, 3, 4]

let foo = {prop: 123};
let bar = {...foo}; //Object.assign({}, foo);

foo.prop = 456;

console.log(bar); // {prop: 123}
</code></pre>
<p>For example an array one level deep containing objects property will still be shallow copies.</p>
<p><strong>Shallow copy once we introduce objects:</strong></p>
<pre><code class="javascript language-javascript">let a = [{a:1}, {b:2}, {c:3}];
const b = [...a]; // a.map(el =&gt; el);

a[0].a = 'first index in the array!';

console.log(b) // [{"a":"first index in the array!"}, {"b":2}, {"c":3}]
</code></pre>
<p>This means once our data structure introduces any nesting (arrays, objects or functions) we're back to a shallow copy of the data.</p>
<p><strong>Shallow copy once we introduce nested value:</strong></p>
<pre><code class="javascript language-javascript">let a = [[1, 2, 3], 2, 3];
const b = [...a];

a[0][0] = 'first index in the array!';

console.log(JSON.stringify(b)) // [["first index in the array!", 2, 3], 2, 3]
</code></pre>
<h3 id="howcanwefixthis">How can we fix this?</h3>
<p>So now that we've established how it works what can we do about it?</p>
<p>You'll find various solutions online from over the years, solutions which include recursively traversing the data structures and copying each element such as below just for this demo. While they work they're not always performant and commonly have issues.</p>
<p><strong>Random utility to deep copy an array:</strong></p>
<pre><code class="javascript language-javascript">// Don't use this!
function deepCopy(arr, result) {
  for (let el of arr) {
    if (Array.isArray(el)) {
      result.push(deepCopy(el, []));
    } else {
      result.push(el);
    }
  }

  return result;
}

let a = [[7, 8, 9, [10, 11]], 2, 3];
const b = [...a];
const c = deepCopy(a, []);

a[0][0] = 'first index in the array!';
console.log(b); // [["first index in the array!",8,9,[10,11]],2,3]
console.log(c); // [[7,8,9,[10,11]],2,3]
</code></pre>
<h3 id="jsonstringifytotherescue">JSON.stringify to the rescue?</h3>
<p>What if we could type cast all of our values to a string and read them back in? That’s exactly what JSON.stringify does for us. It's become the defacto method of deep copying.. so much in fact browser vendors have spent extra time making it more performant over the years.</p>
<pre><code class="javascript language-javascript">let a = [[7, 8, 9, [10, 11]], 2, 3];
const b = [...a];
const c = JSON.parse(JSON.stringify(a));

a[0][0] = 'first index in the array!';
console.log(b); // [["first index in the array!",8,9,[10,11]],2,3]
console.log(c); // [[7,8,9,[10,11]],2,3]
</code></pre>
<p>It works, we're done!… well not so fast. The JSON.stringify method while fast and gets us most of the way there still has some pretty significant drawbacks.</p>
<p><strong>Example using a Map and Date</strong></p>
<pre><code class="javascript language-javascript">const map = new Map();
map.set('a', 1);

let date = new Date();

let a = [0, 1, {c: map}, date];
const b = JSON.parse(JSON.stringify(a)); // [0, 1, {c:{}}, '2022-04-07T22:15:09.947Z']
</code></pre>
<p>Notice how our Map is now just an empty object, in addition since the data is "stringified" and parsed we get the actual value for Date rather than access to the date object itself. This also of course applies to Set, and regex values as well.</p>
<h3 id="introducingstructuredclonetotherescuemostly">Introducing structuredClone() to the rescue (mostly)</h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/structuredClone#syntax">Usage from MDN.</a></p>
<pre><code class="javascript language-javascript">structuredClone(value)
structuredClone(value, { transfer })
</code></pre>
<p>This simplifies almost everything for us.</p>
<p><strong>The same example from above with structuredClone:</strong></p>
<pre><code class="javascript language-javascript">const map = new Map();
map.set('a', 1);

let date = new Date();

let a = [0, 1, {c: map}, date];
const b = JSON.parse(JSON.stringify(a));
const c = structuredClone(a);
a[1] = 2;

// [0, 1, {c:{}}, '2022-04-07T22:15:09.947Z']
console.log(b);

// [0, 1, {{c: Map(1)}, Thu Apr 07 2022 18:15:17 GMT-0400 (Eastern Daylight Time)]
console.log(c);

c[3].getDate() + 5 // Current date + 5 returns the result

// Can't do this since it's just a string.
b[3].getDate() + 5 // Uncaught TypeError: b[3].getDate is not a function
</code></pre>
<h3 id="caveatsofstructuredclone">Caveats of structuredClone</h3>
<p>There's only one real issue currently that affects all the methods above, functions and dom elements.</p>
<p>Functions error</p>
<pre><code class="javascript language-javascript">let a = [0, 1, {c: () =&gt; true} ];
// Uncaught DOMException: Failed to execute 'structuredClone' on 'Window'
const c = structuredClone(a);
</code></pre>
<p>As long as you’re aware of the caveats (which are generally small edge cases in our data) structuredClone is the recommended approach for deep copying data within JavaScript. It’s a first class citizen and removes some hacks and using JSON parsing which has always felt like a hack.</p>
<p>I definitely recommend reading the link above to <a href="https://2ality.com/2022/01/structured-clone.html">2ality</a> on further caveats and a fantastic in depth description into structuredClone which goes much further than the MDN article.</p>                    </section>
                    <hr/>
                    <footer>
                                            </footer>
                </article>
                <nav class="nav">
    <ul>
        <li><a class="link-button" rel="prev" href="/2022/demos-and-deviations/">← Demos and Deviations Project</a></li>        <li><a class="link-button" rel="prev" href="/2022/float-text-from-cursor/">Floating text from cursor generative demo →</a></li>    </ul>
</nav>            </section>
            <section class="secondary">
                <aside class="aside-list">
            <h3>Find Me</h3>
            <ol>
                <li><a href="https://twitter.com/loktar00">@loktar00</a></li><li><a href="https://codepen.io/loktar00">Codepen</a></li><li><a href="https://github.com/loktar00">Github</a></li><li><a href="https://stackoverflow.com/users/322395/loktar">Stackoverflow</a></li><li><a href="https://www.dwitter.net/u/loktar">Dwitter</a></li>
            </ol>
        </aside><aside class="aside-list">
            <h3>Projects</h3>
            <ol>
                <li><a href="https://github.com/loktar00/react-lazy-load">react-lazy-load</a></li><li><a href="https://catbrownrealtor.com/">Cat Brown Realtor</a></li><li><a href="https://github.com/loktar00/jest">Jest Game Framework</a></li><li><a href="https://codegolf.stackexchange.com/questions/30322/make-it-look-like-im-working/30335#30335">gui hacker</a></li><li><a href="https://github.com/loktar00/JQuery-Snowfall">jQuery Snowfall</a></li><li><a href="http://www.retroships.com/">RetroShips</a></li><li><a href="https://zombiegames.net/">Zombiegames.net</a></li>
            </ol>
        </aside>            </section>
        </main>
        <footer class="footer">
    © 2023, Built by <a href="https://github.com/loktar00">Loktar</a>
</footer>    </div>
  </body>